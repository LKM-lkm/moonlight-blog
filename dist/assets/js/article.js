let currentArticleIndex=-1,articlesList=[];function updateReadCount(e){const t="article_read_count",n="article_read_records";let a=JSON.parse(localStorage.getItem(n)||"{}"),i=JSON.parse(localStorage.getItem(t)||"{}");const r=Date.now();return r-(a[e]||0)>18e5&&(i[e]=(i[e]||0)+1,localStorage.setItem(t,JSON.stringify(i))),a[e]=r,localStorage.setItem(n,JSON.stringify(a)),i[e]||0}function getReadCount(e){return JSON.parse(localStorage.getItem("article_read_count")||"{}")[e]||0}function formatReadCount(e){return e<1e3?e.toString():e<1e4?(e/1e3).toFixed(1)+"k":(e/1e4).toFixed(1)+"w"}function renderReadCount(e){const t=getReadCount(e),n=document.getElementById("article-read-count");n&&(n.innerHTML=`<i class="fas fa-eye"></i> ${formatReadCount(t)} 次阅读`)}function getQueryParam(e){return new URL(window.location.href).searchParams.get(e)}async function loadArticlesList(){try{const e=await fetch("articles/index.json");if(e.ok){articlesList=await e.json();const t=getQueryParam("file");currentArticleIndex=articlesList.findIndex((e=>e.file===t))}}catch(e){console.error("加载文章列表失败:",e)}}function renderNavigation(){const e=document.getElementById("article-navigation");if(!e||-1===currentArticleIndex)return;let t='<div class="article-navigation">';if(currentArticleIndex>0){const e=articlesList[currentArticleIndex-1];t+=`\n            <a href="article.html?file=${encodeURIComponent(e.file)}" class="nav-link prev-link">\n                <i class="fas fa-chevron-left"></i>\n                <div class="nav-content">\n                    <span class="nav-label">上一篇</span>\n                    <span class="nav-title">${e.title}</span>\n                </div>\n            </a>\n        `}else t+='<div class="nav-link prev-link disabled"><i class="fas fa-chevron-left"></i><span>已是第一篇</span></div>';if(currentArticleIndex<articlesList.length-1){const e=articlesList[currentArticleIndex+1];t+=`\n            <a href="article.html?file=${encodeURIComponent(e.file)}" class="nav-link next-link">\n                <div class="nav-content">\n                    <span class="nav-label">下一篇</span>\n                    <span class="nav-title">${e.title}</span>\n                </div>\n                <i class="fas fa-chevron-right"></i>\n            </a>\n        `}else t+='<div class="nav-link next-link disabled"><span>已是最后一篇</span><i class="fas fa-chevron-right"></i></div>';t+="</div>",e.innerHTML=t}async function renderArticle(){const e=getQueryParam("file");if(e){await loadArticlesList();try{const t=await fetch(`/articles/${e}`);if(!t.ok)throw new Error("文章加载失败");const n=await t.text(),a=n.match(/^---([\s\S]*?)---/);let i={},r=n;if(a){const e=a[1].trim();r=n.slice(a[0].length).trim(),e.split("\n").forEach((e=>{const[t,...n]=e.split(":");i[t.trim()]=n.join(":").trim().replace(/^"|"$/g,"")}))}let c="";if(i.cover&&(c+=`<img class='article-cover' src='${i.cover}' alt='封面'>`),i.title&&(c+=`<h1 class='article-title'>${i.title}</h1>`),c+="<div class='article-meta-info'>",i.author&&(c+=`<span class='article-author'><i class='fas fa-user'></i> ${i.author}</span>`),i.date&&(c+=`<span class='article-date'><i class='fas fa-calendar-alt'></i> ${i.date}</span>`),i.tags){const e=i.tags.split(",").map((e=>e.trim())).filter(Boolean);e.length>0&&(c+="<span class='article-tags'>"+e.map((e=>`<span class='tag tag-link' data-tag='${e}'>${e}</span>`)).join("")+"</span>")}c+="</div>",i.excerpt&&(c+=`<div class='article-excerpt'>${i.excerpt}</div>`),document.getElementById("article-meta").innerHTML=c;let l=`<div class='article-content'>${marked.parse(r)}</div>`;document.getElementById("article-container").innerHTML=l,window.renderMathInElement&&window.renderMathInElement(document.getElementById("article-container"),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]}),document.querySelectorAll(".tag-link").forEach((e=>{e.onclick=function(){window.location.href=`index.html?tag=${encodeURIComponent(this.dataset.tag)}`}})),renderNavigation(),updateReadCount(e),renderReadCount(e)}catch(e){document.getElementById("article-container").innerHTML=`<p>加载失败：${e.message}</p>`}}else document.getElementById("article-container").innerHTML="<p>未指定文章文件。</p>"}document.addEventListener("DOMContentLoaded",renderArticle);