document.addEventListener("DOMContentLoaded",(function(){if(!localStorage.getItem("isLoggedIn"))return void(window.location.href="login.html");const e=document.getElementById("article-title"),t=document.getElementById("article-category"),a=document.getElementById("article-tags"),n=document.getElementById("article-description"),i=document.getElementById("article-cover"),l=document.getElementById("cover-preview"),s=document.getElementById("cover-upload-btn"),c=document.getElementById("file-upload"),o=document.getElementById("upload-zone"),d=document.getElementById("attachment-list"),r=document.getElementById("article-status"),f=document.getElementById("article-comments"),m=document.getElementById("article-date"),u=document.getElementById("preview-btn"),v=document.getElementById("draft-btn"),g=document.getElementById("publish-btn"),p=document.getElementById("preview-modal"),h=document.getElementById("preview-close"),y=(new Date).toISOString().slice(0,16);m.value=y;const w=new EasyMDE({element:document.getElementById("markdown-editor"),autofocus:!0,spellChecker:!1,renderingConfig:{codeSyntaxHighlighting:!0},toolbar:["bold","italic","heading","|","quote","code","unordered-list","ordered-list","|","link","image","table","|","preview","side-by-side","fullscreen","|","guide"],placeholder:"在这里开始撰写文章内容...",status:["lines","words","cursor"]}),I=new URLSearchParams(window.location.search).get("id");function E(e){if(!e||0===e.length)return;const t=d.querySelector(".no-attachments");t&&d.removeChild(t),Array.from(e).forEach((e=>{if(e.size>10485760)return void alert(`文件 ${e.name} 超过10MB限制`);const t=document.createElement("div");t.className="attachment-item";const a=S(e.name),n=L(e.size);t.innerHTML=`\n                <div class="attachment-info">\n                    <div class="attachment-icon">\n                        <i class="${a}"></i>\n                    </div>\n                    <div>\n                        <div class="attachment-name">${e.name}</div>\n                        <div class="attachment-size">${n}</div>\n                    </div>\n                </div>\n                <div class="attachment-actions">\n                    <button type="button" class="preview-btn" title="预览">\n                        <i class="fas fa-eye"></i>\n                    </button>\n                    <button type="button" class="delete-btn" title="删除">\n                        <i class="fas fa-trash-alt"></i>\n                    </button>\n                </div>\n            `;t.querySelector(".delete-btn").addEventListener("click",(function(){d.removeChild(t),0===d.children.length&&(d.innerHTML='\n                        <div class="no-attachments">\n                            <i class="fas fa-file-upload"></i>\n                            <p>尚未添加附件</p>\n                        </div>\n                    ')}));const i=new FileReader;i.onload=function(a){t.dataset.fileData=a.target.result,t.dataset.fileName=e.name,t.dataset.fileSize=e.size,t.dataset.fileType=e.type},i.readAsDataURL(e),d.appendChild(t)}))}function S(e){return{pdf:"fas fa-file-pdf",doc:"fas fa-file-word",docx:"fas fa-file-word",txt:"fas fa-file-alt",rtf:"fas fa-file-alt",xls:"fas fa-file-excel",xlsx:"fas fa-file-excel",csv:"fas fa-file-csv",ppt:"fas fa-file-powerpoint",pptx:"fas fa-file-powerpoint",zip:"fas fa-file-archive",rar:"fas fa-file-archive","7z":"fas fa-file-archive",jpg:"fas fa-file-image",jpeg:"fas fa-file-image",png:"fas fa-file-image",gif:"fas fa-file-image",svg:"fas fa-file-image",mp3:"fas fa-file-audio",wav:"fas fa-file-audio",ogg:"fas fa-file-audio",mp4:"fas fa-file-video",avi:"fas fa-file-video",mov:"fas fa-file-video",html:"fas fa-file-code",css:"fas fa-file-code",js:"fas fa-file-code",json:"fas fa-file-code",php:"fas fa-file-code",py:"fas fa-file-code"}[e.split(".").pop().toLowerCase()]||"fas fa-file"}function L(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}function b(i){if(!e.value.trim())return alert("请输入文章标题"),void e.focus();if(!w.value().trim())return alert("请输入文章内容"),void w.codemirror.focus();!function(e){let t=JSON.parse(localStorage.getItem("articles")||"[]");const a=t.findIndex((t=>t.id===e.id));-1!==a?t[a]=e:t.push(e);localStorage.setItem("articles",JSON.stringify(t))}({id:I||Date.now().toString(36)+Math.random().toString(36).substr(2,5),title:e.value.trim(),description:n.value.trim(),category:t.value,tags:a.value.split(",").map((e=>e.trim())).filter((e=>e)),content:w.value(),coverImage:localStorage.getItem("tempCoverImage")||null,status:i?"published":"draft",allowComments:f.checked,date:m.value?new Date(m.value).toISOString():(new Date).toISOString(),created_at:(new Date).toISOString(),updated_at:(new Date).toISOString(),attachments:B()}),localStorage.removeItem("tempCoverImage"),alert(i?"文章发布成功！":"草稿保存成功！"),window.location.href="index.html#articles"}function B(){const e=document.querySelectorAll(".attachment-item"),t=[];return e.forEach((e=>{e.dataset.fileData&&t.push({name:e.dataset.fileName,size:parseInt(e.dataset.fileSize),type:e.dataset.fileType,data:e.dataset.fileData})})),t}I&&function(i){const s=JSON.parse(localStorage.getItem("articles")||"[]").find((e=>e.id===i));if(!s)return alert("文章不存在！"),void(window.location.href="index.html#articles");if(e.value=s.title,t.value=s.category,a.value=s.tags.join(", "),n.value=s.description,w.value(s.content),r.checked="published"===s.status,f.checked=s.allowComments,s.date){const e=new Date(s.date);m.value=e.toISOString().slice(0,16)}s.coverImage&&(l.innerHTML=`<img src="${s.coverImage}" alt="文章封面">`,localStorage.setItem("tempCoverImage",s.coverImage));s.attachments&&s.attachments.length>0&&(d.innerHTML="",s.attachments.forEach((e=>{const t=document.createElement("div");t.className="attachment-item";const a=S(e.name),n=L(e.size);t.innerHTML=`\n                    <div class="attachment-info">\n                        <div class="attachment-icon">\n                            <i class="${a}"></i>\n                        </div>\n                        <div>\n                            <div class="attachment-name">${e.name}</div>\n                            <div class="attachment-size">${n}</div>\n                        </div>\n                    </div>\n                    <div class="attachment-actions">\n                        <button type="button" class="preview-btn" title="预览">\n                            <i class="fas fa-eye"></i>\n                        </button>\n                        <button type="button" class="delete-btn" title="删除">\n                            <i class="fas fa-trash-alt"></i>\n                        </button>\n                    </div>\n                `,t.dataset.fileData=e.data,t.dataset.fileName=e.name,t.dataset.fileSize=e.size,t.dataset.fileType=e.type;t.querySelector(".delete-btn").addEventListener("click",(function(){d.removeChild(t),0===d.children.length&&(d.innerHTML='\n                            <div class="no-attachments">\n                                <i class="fas fa-file-upload"></i>\n                                <p>尚未添加附件</p>\n                            </div>\n                        ')})),d.appendChild(t)})))}(I),s.addEventListener("click",(function(){i.click()})),i.addEventListener("change",(function(e){const t=e.target.files[0];if(t){if(!t.type.match("image.*"))return void alert("请选择图片文件");const e=new FileReader;e.onload=function(e){l.innerHTML=`<img src="${e.target.result}" alt="文章封面">`,localStorage.setItem("tempCoverImage",e.target.result)},e.readAsDataURL(t)}})),o.addEventListener("click",(function(){c.click()})),o.addEventListener("dragover",(function(e){e.preventDefault(),this.classList.add("drag-over")})),o.addEventListener("dragleave",(function(){this.classList.remove("drag-over")})),o.addEventListener("drop",(function(e){e.preventDefault(),this.classList.remove("drag-over");E(e.dataTransfer.files)})),c.addEventListener("change",(function(e){E(e.target.files)})),u.addEventListener("click",(function(){!function(){const n=e.value||"无标题",i=t.value?t.options[t.selectedIndex].text:"未分类",l=a.value||"无标签",s=w.value(),c=new Date(m.value||Date.now()).toLocaleDateString("zh-CN");document.getElementById("preview-title").textContent=n,document.getElementById("preview-category").textContent=i,document.getElementById("preview-tags").textContent=l,document.getElementById("preview-date").textContent=c,document.getElementById("preview-content").innerHTML=marked.parse(s);const o=document.getElementById("preview-attachments"),d=document.querySelectorAll(".attachment-item");if(0===d.length)o.style.display="none";else{o.style.display="block";const e=o.querySelector(".attachments-preview-list");e.innerHTML="",d.forEach((t=>{const a=t.querySelector(".attachment-name").textContent,n=t.querySelector(".attachment-size").textContent,i=t.querySelector(".attachment-icon i").className,l=document.createElement("li");l.innerHTML=`\n                    <i class="${i} attachment-preview-icon"></i>\n                    <div class="attachment-preview-info">\n                        <div class="attachment-preview-name">${a}</div>\n                        <div class="attachment-preview-size">${n}</div>\n                    </div>\n                    <a href="#" class="attachment-preview-download">\n                        <i class="fas fa-download"></i> 下载\n                    </a>\n                `,e.appendChild(l)}))}p.classList.add("active")}()})),h.addEventListener("click",(function(){p.classList.remove("active")})),v.addEventListener("click",(function(){b(!1)})),g.addEventListener("click",(function(){b(!0)}));const C=document.createElement("script");C.src="https://cdn.jsdelivr.net/npm/marked/marked.min.js",document.head.appendChild(C)}));